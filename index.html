<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pilot Trainer Supply/Demand Planner</title>
    <link rel="stylesheet" href="styles.css?v=2025012722">
    <script>
        // Apply dark mode immediately to prevent flash
        const isDarkMode = localStorage.getItem('darkMode') === 'true';
        if (isDarkMode) {
            document.documentElement.classList.add('dark-mode-loading');
            // Set background color immediately to prevent flash
            document.documentElement.style.backgroundColor = '#1a1a1a';
        }
        
        // Store the active tab for immediate view switching
        const activeTab = localStorage.getItem('activeTab') || 'dashboard';
        document.documentElement.setAttribute('data-active-tab', activeTab);
        
        // Store current location for immediate application
        const savedLocation = localStorage.getItem('currentLocation');
        if (savedLocation) {
            document.documentElement.setAttribute('data-location', savedLocation);
        }
    </script>
    <style>
        /* Critical inline styles to prevent FOUC */
        .table-container { min-height: 100px; }
        .sticky-first-column { left: 0 !important; }
        
        /* Prevent dark mode flash - apply dark background to html immediately */
        html.dark-mode-loading {
            background-color: #1a1a1a;
        }
        
        /* Apply dark backgrounds immediately to prevent content flash */
        html.dark-mode-loading body {
            background-color: #1a1a1a !important;
            color: #e0e0e0 !important;
        }

        html.dark-mode-loading section {
            background-color: #2a2a2a !important;
            color: #e0e0e0 !important;
        }

        html.dark-mode-loading .chart-container,
        html.dark-mode-loading .viz-container,
        html.dark-mode-loading .alerts-section,
        html.dark-mode-loading .table-container,
        html.dark-mode-loading .gantt-container,
        html.dark-mode-loading .modal-content,
        html.dark-mode-loading .data-table,
        html.dark-mode-loading .gantt-table,
        html.dark-mode-loading .metric-card {
            background-color: #2a2a2a !important;
            color: #e0e0e0 !important;
        }

        /* Form controls and interactive elements */
        html.dark-mode-loading select,
        html.dark-mode-loading input,
        html.dark-mode-loading textarea,
        html.dark-mode-loading button,
        html.dark-mode-loading .btn {
            background-color: #444 !important;
            color: #e0e0e0 !important;
            border-color: #666 !important;
        }

        /* Table elements */
        html.dark-mode-loading th,
        html.dark-mode-loading td {
            background-color: #2a2a2a !important;
            color: #e0e0e0 !important;
            border-color: #444 !important;
        }

        /* Gantt chart specific elements */
        html.dark-mode-loading .gantt-empty-cell,
        html.dark-mode-loading .gantt-cohort-cell,
        html.dark-mode-loading .gantt-phase-cell {
            background-color: #1a1a1a !important;
            border-color: #444 !important;
        }
        
        /* Prevent view flash - show correct view immediately */
        .view {
            display: none;
        }
        html[data-active-tab="dashboard"] #dashboard-view,
        html[data-active-tab="planner"] #planner-view,
        html[data-active-tab="settings"] #settings-view,
        html[data-active-tab="scenarios"] #scenarios-view {
            display: block;
        }
        
        /* Set correct nav tab active state */
        .nav-tab {
            background-color: transparent;
        }
        html[data-active-tab="dashboard"] .nav-tab[data-view="dashboard"],
        html[data-active-tab="planner"] .nav-tab[data-view="planner"],
        html[data-active-tab="settings"] .nav-tab[data-view="settings"],
        html[data-active-tab="scenarios"] .nav-tab[data-view="scenarios"] {
            background-color: #0d6efd;
            color: white;
        }
        
        /* Apply active state based on saved location */
        html[data-location="AU"] .location-toggle[data-location="AU"],
        html:not([data-location]) .location-toggle[data-location="AU"] {
            background-color: #2196F3;
            color: white;
        }
        html[data-location="NZ"] .location-toggle[data-location="NZ"] {
            background-color: #2196F3;
            color: white;
        }
        
        /* Dark mode button styles to prevent flash */
        html.dark-mode-loading #dark-mode-toggle {
            background-color: #444;
            color: #e0e0e0;
            border-color: #666;
        }
        html.dark-mode-loading .btn.btn-secondary {
            background-color: #444;
            border-color: #666;
            color: #e0e0e0;
        }

        /* Pathway Modal Layout Styles */
        #pathway-modal .pathway-form-row {
            display: grid;
            gap: 15px;
            margin-bottom: 15px;
        }

        /* Four-column layout for main pathway fields */
        #pathway-modal .pathway-form-row.four-column {
            grid-template-columns: 1fr 2fr 1.5fr 1.5fr;
        }

        /* Three-column layout for rank fields */
        #pathway-modal .pathway-form-row:not(.four-column) {
            grid-template-columns: 1fr 1fr 1fr;
        }

        /* Pathway ID field styling */
        #pathway-modal #pathway-id {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            text-transform: uppercase;
        }

        #pathway-modal #pathway-id:invalid {
            border-color: #dc3545;
            box-shadow: 0 0 0 2px rgba(220,53,69,.1);
        }

        #pathway-modal #pathway-id:valid {
            border-color: #28a745;
            box-shadow: 0 0 0 2px rgba(40,167,69,.1);
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>Pilot Trainer Supply/Demand Planner</h1>
            <div class="header-controls">
                <nav class="main-nav">
                    <button class="nav-tab" data-view="dashboard">Dashboard</button>
                    <button class="nav-tab" data-view="planner">Planner</button>
                    <button class="nav-tab" data-view="settings">Settings</button>
                    <button class="nav-tab" data-view="scenarios">Scenarios</button>
                </nav>
                <div class="location-selector">
                    <button class="location-toggle" data-location="AU">AU</button>
                    <button class="location-toggle" data-location="NZ">NZ</button>
                </div>
                <button id="dark-mode-toggle" class="btn btn-secondary" title="Toggle Dark Mode">
                    <span class="dark-mode-icon">üåô</span>
                </button>
                <button id="help-icon" class="help-icon" onclick="showHelpModal()" title="Help (F1)">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                        <line x1="12" y1="17" x2="12.01" y2="17"></line>
                    </svg>
                </button>
            </div>
        </header>

        <!-- Dashboard View -->
        <div id="dashboard-view" class="view">
            <!-- Enhanced Dashboard -->
            <div class="dashboard-container" id="dashboard-enhanced">
                <!-- Dashboard Navigation Controls -->
                <div class="dashboard-navigation" style="margin-bottom: 20px; display: flex; justify-content: center; align-items: center; gap: 15px;">
                    <button class="btn btn-secondary" onclick="navigateDashboard(-1)" title="Previous month">
                        <span style="font-size: 1.2em;">‚óÄ</span>
                    </button>
                    <span id="dashboard-time-display" style="font-weight: bold; font-size: 1.1em;">Current View</span>
                    <button class="btn btn-secondary" onclick="navigateDashboard(1)" title="Next month">
                        <span style="font-size: 1.2em;">‚ñ∂</span>
                    </button>
                    <button class="btn btn-secondary" onclick="navigateDashboard(0)" title="Go to today">
                        Today
                    </button>
                </div>
                
                <!-- Enhanced Metrics Cards with Trends -->
                <div class="metrics-row">
                    <div class="metric-card clean enhanced">
                        <div class="metric-label">Trainees in Training</div>
                        <div class="metric-value" id="total-trainees-v2">0</div>
                        <div class="metric-trend" id="total-trainees-trend"></div>
                        <div class="metric-detail" id="total-trainees-detail"></div>
                    </div>
                    <div class="metric-card clean enhanced">
                        <div class="metric-label">Trainer Utilization</div>
                        <div class="metric-value" id="trainer-utilization-v2">0%</div>
                        <div class="metric-trend" id="trainer-utilization-trend"></div>
                        <div class="metric-detail" id="trainer-utilization-detail"></div>
                    </div>
                    <div class="metric-card clean enhanced">
                        <div class="metric-label">Completions (3 months)</div>
                        <div class="metric-value" id="upcoming-completions-v2">0</div>
                        <div class="metric-trend" id="upcoming-completions-trend"></div>
                        <div class="metric-detail" id="upcoming-completions-detail"></div>
                    </div>
                    <div class="metric-card clean enhanced">
                        <div class="metric-label">Capacity Warnings</div>
                        <div class="metric-value" id="capacity-warnings-v2">0</div>
                        <div class="metric-trend" id="capacity-warnings-trend"></div>
                        <div class="metric-detail" id="capacity-warnings-detail"></div>
                    </div>
                </div>

                <!-- Enhanced Charts Section -->
                <div class="charts-row">
                    <div class="chart-container enhanced">
                        <div class="chart-header">
                            <h3>Trainer Demand Over Time</h3>
                            <button class="btn-export-chart" data-chart="demand-v2" title="Export Chart">
                                <span>üìä</span>
                            </button>
                        </div>
                        <canvas id="demand-chart-v2"></canvas>
                    </div>
                    <div class="chart-container enhanced">
                        <div class="chart-header">
                            <h3>Trainer Supply & Demand Overview</h3>
                            <button class="btn-export-chart" data-chart="supply-demand-v2" title="Export Chart">
                                <span>üìä</span>
                            </button>
                        </div>
                        <canvas id="supply-demand-overview-v2"></canvas>
                    </div>
                </div>
                
                <!-- New Dashboard Visualizations -->
                <div class="visualization-row">
                    <!-- Trainer Utilization Heat Map -->
                    <div class="viz-container">
                        <h3>Trainer Utilization Heat Map</h3>
                        <p class="viz-subtitle">Monthly utilization percentage by trainer category for the current year. Colors indicate: Green (0-60%), Blue (60-80%), Amber (80-100%), Red (>100%)</p>
                        <div id="trainer-heatmap"></div>
                    </div>
                    
                    <!-- Supply vs Demand Area Chart -->
                    <div class="viz-container">
                        <h3>Trainer Supply vs Demand</h3>
                        <p class="viz-subtitle">12-month forecast showing trainer supply capacity against projected demand by category</p>
                        <div class="chart-wrapper" style="position: relative; height: 300px;">
                            <canvas id="supply-demand-chart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Additional Visualizations -->
                <div class="visualization-row">
                    <!-- Training Phase Breakdown -->
                    <div class="viz-container">
                        <h3>Active Training Phases</h3>
                        <p class="viz-subtitle">Number of trainees currently in each training phase (Ground School, Simulator, Line Training)</p>
                        <div class="chart-wrapper" style="position: relative; height: 250px;">
                            <canvas id="phase-breakdown-chart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Workload Distribution -->
                    <div class="viz-container">
                        <h3>Trainer Workload Distribution</h3>
                        <p class="viz-subtitle">Projected workload distribution across trainer categories for the next 12 months</p>
                        <div class="chart-wrapper" style="position: relative; height: 250px;">
                            <canvas id="workload-chart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Forecast & Metrics Cards -->
                <div class="metrics-detail-row">
                    <div class="detail-card">
                        <div class="detail-icon">üìà</div>
                        <div class="detail-content">
                            <h4>Peak Demand Period</h4>
                            <div class="detail-value" id="peak-demand-period">-</div>
                            <div class="detail-subtext" id="peak-demand-detail">-</div>
                        </div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-icon">‚öñÔ∏è</div>
                        <div class="detail-content">
                            <h4>Supply/Demand Balance</h4>
                            <div class="detail-value" id="supply-balance">-</div>
                            <div class="detail-subtext" id="balance-detail">-</div>
                        </div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-icon">üéØ</div>
                        <div class="detail-content">
                            <h4>Training Efficiency</h4>
                            <div class="detail-value" id="training-efficiency">-</div>
                            <div class="detail-subtext" id="efficiency-detail">-</div>
                        </div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-icon">üîÆ</div>
                        <div class="detail-content">
                            <h4>Forecast Confidence</h4>
                            <div class="detail-value" id="forecast-confidence">-</div>
                            <div class="detail-subtext" id="confidence-detail">-</div>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Training Pipeline -->
                <div class="pipeline-section enhanced">
                    <div class="pipeline-header">
                        <h3>Training Pipeline</h3>
                        <div class="pipeline-filters">
                            <select id="pipeline-filter" class="filter-select">
                                <option value="all">All Cohorts</option>
                                <option value="completing-soon">Completing Soon</option>
                                <option value="in-progress">In Progress</option>
                                <option value="starting-soon">Starting Soon</option>
                            </select>
                        </div>
                    </div>
                    <div id="pipeline-timeline-v2"></div>
                </div>

                <!-- Enhanced Alerts Section -->
                <div class="alerts-section enhanced">
                    <div class="alerts-header">
                        <h3>Alerts & Warnings <span class="alert-badge" id="alert-count">0</span></h3>
                        <div class="alert-controls">
                            <select id="alert-filter" class="filter-select">
                                <option value="all">All Alerts</option>
                                <option value="danger">Critical Only</option>
                                <option value="warning">Warnings Only</option>
                                <option value="info">Info Only</option>
                            </select>
                            <button class="btn-clear-alerts" id="clear-acknowledged">Clear Acknowledged</button>
                        </div>
                    </div>
                    <div id="alerts-container-v2"></div>
                </div>
                
                <!-- Export Dashboard Button -->
                <div class="dashboard-export-section">
                    <button class="btn btn-secondary" id="export-dashboard">
                        Export Dashboard
                    </button>
                    <button class="btn btn-secondary" id="load-demo-data" style="margin-left: 10px;">
                        Load Demo Data
                    </button>
                </div>
            </div>
        </div>

        <!-- Planner View -->
        <div id="planner-view" class="view">
            <!-- Add Cohort Section -->
            <section class="add-cohort-section">
                <div class="section-header">
                    <h2>Add New Cohort</h2>
                    <div class="header-buttons">
                        <button id="training-planner-btn" class="btn btn-secondary">Training Planner</button>
                        <button id="export-training-btn" class="btn btn-secondary">Export Training</button>
                        <button id="import-training-btn" class="btn btn-secondary">Import Training</button>
                    </div>
                </div>
                <form id="add-cohort-form" class="add-cohort-form">
                    <div class="form-group">
                        <label for="num-trainees">Number of Trainees:</label>
                        <input type="number" id="num-trainees" name="numTrainees" min="1" value="2" required>
                    </div>
                    <div class="form-group">
                        <label for="pathway">Pathway:</label>
                        <select id="pathway" name="pathway" required>
                            <option value="">Select a pathway</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="start-year">Start Year:</label>
                        <select id="start-year" name="startYear" required>
                            <option value="">Select year</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="start-fortnight">Start Fortnight:</label>
                        <select id="start-fortnight" name="startFortnight" required>
                            <option value="">Select fortnight</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">Add Cohort</button>
                </form>
            </section>

            <!-- View Controls Section -->
            <section class="view-controls-section">
                <div class="view-controls">
                    <button id="nav-left" class="nav-arrow" title="Previous period">‚óÄ</button>
                    <button class="view-btn" data-view="6months">6M</button>
                    <button class="view-btn active" data-view="12months">12M</button>
                    <button class="view-btn" data-view="18months">18M</button>
                    <button id="nav-right" class="nav-arrow" title="Next period">‚ñ∂</button>
                    <div class="separator"></div>
                    <button class="view-btn" data-view="all">All</button>
                    <div class="separator"></div>
                    <button id="today-btn" class="today-btn">üìç Today</button>
                </div>
                <div class="scenario-status-controls">
                    <div id="scenario-status-display" class="scenario-status-display">
                        <span id="scenario-status-text" class="scenario-status-text"><strong>Scenario:</strong> New Scenario</span>
                        <button id="scenario-save-btn" class="scenario-btn" title="Save scenario" style="display: none;">Save</button>
                        <button id="scenario-update-btn" class="scenario-btn" title="Save current scenario" style="display: none;">üìù Save</button>
                    </div>
                </div>
            </section>

            <!-- Gantt Chart Section -->
            <section class="gantt-chart-section">
                <div class="section-header">
                    <h2>Training Timeline (Gantt Chart)</h2>
                    <div class="gantt-controls">
                        <select id="group-by-filter" class="filter-select">
                            <option value="none">No Grouping</option>
                            <option value="type" selected>Group by Type</option>
                            <option value="rank">Group by Rank</option>
                        </select>
                        <button id="copy-table-data" class="btn btn-secondary" style="margin-left: 10px;">üìã Copy Tables</button>
                        <button id="merge-cohorts-btn" class="btn btn-secondary" style="margin-left: 10px;">üîÄ Merge Cohorts</button>
                        <button id="toggle-gantt-height" class="btn btn-secondary" style="margin-left: 10px;" title="Switch to fixed 500px height">üìè Fixed Height</button>
                    </div>
                </div>
                <div id="gantt-chart-container" class="gantt-container">
                    <!-- Gantt chart will be generated here -->
                </div>
            </section>

            <!-- Training Commencement Summary Section -->
            <section class="commencement-summary-section">
                <div class="section-header" style="position: relative;">
                    <h2>Training Commencement Summary</h2>
                    <button id="commencement-cross-loc-btn" class="btn btn-secondary btn-sm" onclick="toggleCommencementCrossLocation()" title="Toggle cross-location commencements" style="position: absolute; right: 350px; top: 50%; transform: translateY(-50%);">
                        <span id="commencement-cross-loc-icon">üåê</span> <span id="commencement-cross-loc-text">Cross-Location OFF</span>
                    </button>
                    <div id="trainee-summary" style="position: absolute; right: 20px; top: 50%; transform: translateY(-50%); font-size: 1.0em; color: var(--text-primary); font-weight: 500;">
                        <!-- Trainee summary will be populated here -->
                    </div>
                </div>
                <div id="commencement-summary-container" class="table-container">
                    <!-- Commencement summary table will be generated here -->
                </div>
            </section>

            <!-- Demand Table Section -->
            <section class="demand-table-section">
                <div class="section-header">
                    <h2>Trainer Demand</h2>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <span style="font-size: 0.85em; color: var(--text-secondary);">
                            <span style="display: inline-block; width: 6px; height: 6px; background: #3498db; border-radius: 50%; margin-right: 4px;"></span>
                            = Includes cross-location trainer demand
                        </span>
                        <button class="btn btn-secondary btn-sm" onclick="toggleDemandSplitView()" title="Split demand by location">
                            <span id="split-view-icon">üìä</span> <span id="split-view-text">Split by Location</span>
                        </button>
                    </div>
                </div>
                <div id="demand-table-container" class="table-container">
                    <!-- Demand table will be generated here -->
                </div>
            </section>

            <!-- Surplus/Deficit Table Section -->
            <section class="surplus-deficit-section">
                <div class="section-header">
                    <h2>Surplus/Deficit Analysis 
                        <span class="info-icon-wrapper">
                            <span class="info-icon" title="">‚Ñπ</span>
                            <div class="info-tooltip">
                                <h4>Cascading Allocation System</h4>
                                <p>Training capacity is allocated based on priorities:</p>
                                <ul>
                                    <li><strong>P1 (CAD):</strong> Served first by CATB/CATA/STP trainers only</li>
                                    <li><strong>P2 (CP):</strong> Served by RHS trainers, plus any surplus from P1 trainers</li>
                                    <li><strong>P3 (FO):</strong> Served by LHS trainers, plus any surplus from all other trainers</li>
                                </ul>
                                <p>This ensures critical training needs are met first, with remaining capacity cascading to lower priorities.</p>
                            </div>
                        </span>
                    </h2>
                    <div class="surplus-deficit-controls">
                        <button id="resolve-deficits-btn" class="btn btn-warning" style="display: none;" title="Resolve capacity deficits">
                            <span class="toggle-view-icon">üîß</span>
                            <span class="toggle-view-text">Resolve Deficits</span>
                        </button>
                        <button id="toggle-sd-view" class="btn btn-secondary" title="Toggle between simple and detailed views">
                            <span class="toggle-view-icon">üìä</span>
                            <span class="toggle-view-text">Show Detailed View</span>
                        </button>
                    </div>
                </div>
                <div id="surplus-deficit-container" class="table-container">
                    <!-- Surplus/Deficit table will be generated here -->
                </div>
            </section>

            <!-- FTE Summary Section -->
            <section class="fte-summary-section">
                <div class="section-header">
                    <h2>FTE Summary</h2>
                    <div class="button-group">
                        <button id="edit-fte-btn" class="btn btn-secondary">Edit FTE</button>
                        <!-- Save as Default button removed - scenarios now hold FTE source truth -->
                    </div>
                </div>
                <div class="fte-hint" style="margin: -10px 0 10px 0; padding: 6px 12px; background: rgba(13, 110, 253, 0.05); border-radius: 4px; font-size: 0.85em; color: var(--text-secondary);">
                    üí° <strong>Right-click any cell to edit</strong>
                </div>
                <div id="fte-summary-table-container" class="table-container">
                    <!-- FTE Summary table will be generated here -->
                </div>
            </section>

        </div>

        <!-- Settings View -->
        <div id="settings-view" class="view">
            <section class="priority-settings-section">
                <div class="section-header">
                    <h2>Priority Settings
                        <span class="info-icon">i
                            <div class="tooltip-content">
                                <h4>How Priority Allocation Works:</h4>
                                <ul>
                                    <li><strong>P1 (LT-CAD):</strong> Served first by CATB, CATA, STP</li>
                                    <li><strong>P2 (LT-CP):</strong> Served by RHS + any surplus from P1 trainers</li>
                                    <li><strong>P3 (LT-FO):</strong> Served by LHS + any surplus from all other trainers</li>
                                </ul>
                                <h4>Trainer Capabilities:</h4>
                                <ul>
                                    <li><strong>CATB, CATA, STP:</strong> Can perform all line training types (LT-CAD, LT-CP, LT-FO)</li>
                                    <li><strong>RHS:</strong> Can perform LT-CP and LT-FO only (cannot do LT-CAD)</li>
                                    <li><strong>LHS:</strong> Can perform LT-FO only</li>
                                </ul>
                            </div>
                        </span>
                    </h2>
                    <button id="edit-priority-btn" class="btn btn-secondary">Edit Priorities</button>
                </div>
                <div id="priority-settings-container" class="table-container">
                    <!-- Priority settings table will be generated here -->
                </div>
            </section>
            
            <section class="pathways-section">
                <div class="section-header">
                    <h2>Training Pathways</h2>
                    <button id="add-pathway-btn" class="btn btn-primary">Add New Pathway</button>
                </div>
                <div class="location-tabs">
                    <button class="location-tab active" data-location="AU">AU</button>
                    <button class="location-tab" data-location="NZ">NZ</button>
                </div>
                <div id="pathways-table-container" class="table-container">
                    <!-- Pathways table will be generated here -->
                </div>
            </section>
        </div>

        <!-- Modal for FTE Editing -->
        <div id="fte-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Edit Trainer FTE</h2>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="fte-edit-form">
                        <div id="fte-edit-container">
                            <!-- FTE edit form will be generated here -->
                        </div>
                        <div class="modal-footer">
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                            <!-- Save as Default button removed - scenarios now hold FTE source truth -->
                            <button type="button" class="btn btn-secondary modal-cancel">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Modal for Pathway Editing -->
        <div id="pathway-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="pathway-modal-title">Add New Pathway</h2>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="pathway-edit-form">
                        <div class="pathway-form-row four-column">
                            <div class="form-group">
                                <label for="pathway-id">Pathway ID:</label>
                                <input type="text" id="pathway-id" name="pathwayId" required 
                                    placeholder="e.g., A203" pattern="[A-Z][0-9]+" 
                                    title="Must start with a letter followed by numbers (e.g., A203, H209)">
                            </div>
                            <div class="form-group">
                                <label for="pathway-name">Pathway Name:</label>
                                <input type="text" id="pathway-name" name="pathwayName" required>
                            </div>
                            <div class="form-group">
                                <label for="pathway-type">Pathway Type:</label>
                                <select id="pathway-type" name="pathwayType" required>
                                    <option value="CP">Captain (CP)</option>
                                    <option value="FO">First Officer (FO)</option>
                                    <option value="CAD">Cadet (CAD)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="pathway-comments">Comments:</label>
                                <input type="text" id="pathway-comments" name="pathwayComments" 
                                    placeholder="Short notes...">
                            </div>
                        </div>
                        <div class="pathway-form-row">
                            <div class="form-group">
                                <label for="start-rank">Start Rank</label>
                                <input type="text" id="start-rank" name="startRank" 
                                    placeholder="e.g., NBFO">
                            </div>
                            <div class="form-group">
                                <label for="end-rank">End Rank</label>
                                <input type="text" id="end-rank" name="endRank" 
                                    placeholder="e.g., NBCP">
                            </div>
                            <div class="form-group">
                                <label for="usable-months">Usable After (months)</label>
                                <input type="number" id="usable-months" name="usableMonths" 
                                    min="0" value="0" placeholder="0">
                            </div>
                        </div>
                        <h4 style="margin-top: 20px; margin-bottom: 10px;">Training Phases</h4>
                        <div id="pathway-phases-container">
                            <!-- Phase inputs will be generated here -->
                        </div>
                        <button type="button" id="add-phase-btn" class="btn btn-secondary">Add Phase</button>
                        <div class="modal-footer">
                            <button type="submit" class="btn btn-primary">Save Pathway</button>
                            <button type="button" class="btn btn-secondary modal-cancel">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Modal for Cohort Editing -->
        <div id="cohort-modal" class="modal">
            <div class="modal-content cohort-modal-content">
                <div class="modal-header">
                    <h2>Edit Cohort</h2>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="modal-body cohort-modal-body">
                    <form id="cohort-edit-form">
                        <div class="cohort-edit-layout">
                            <!-- Left Column: Basic Info -->
                            <div class="cohort-left-column">
                                <div class="form-group">
                                    <label for="edit-num-trainees">Number of Trainees:</label>
                                    <input type="number" id="edit-num-trainees" name="numTrainees" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label for="edit-pathway">Pathway:</label>
                                    <select id="edit-pathway" name="pathway" required>
                                        <option value="">Select a pathway</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="edit-start-year">Start Year:</label>
                                    <select id="edit-start-year" name="startYear" required>
                                        <option value="">Select year</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="edit-start-fortnight">Start Fortnight:</label>
                                    <select id="edit-start-fortnight" name="startFortnight" required>
                                        <option value="">Select fortnight</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="edit-location">Location:</label>
                                    <select id="edit-location" name="location" required>
                                        <option value="AU">AU</option>
                                        <option value="NZ">NZ</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>
                                        <input type="checkbox" id="enable-cross-location" name="enableCrossLocation">
                                        Enable cross-location trainer usage
                                    </label>
                                </div>
                                <div class="form-group">
                                    <label for="edit-induction-group">Induction Group:</label>
                                    <input type="text" id="edit-induction-group" name="inductionGroup" placeholder="Enter induction group details..." maxlength="150">
                                </div>

                                <!-- Split Cohort Section -->
                                <div class="form-group split-cohort-section">
                                    <div class="split-cohort-header">
                                        <h4>‚úÇÔ∏è Split Cohort</h4>
                                        <p>Divide this cohort into smaller groups with identical settings</p>
                                    </div>
                                    
                                    <div class="split-cohort-table">
                                        <table class="split-table-inner">
                                            <thead>
                                                <tr class="split-row split-header">
                                                    <th class="split-label">Current Cohort</th>
                                                    <th class="split-label">Split Out</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr class="split-row split-data">
                                                    <td class="split-cell current-cohort">
                                                        <strong id="current-trainees-display">8</strong> trainees
                                                    </td>
                                                    <td class="split-cell split-input">
                                                        <div class="split-input-group">
                                                            <input type="number" id="split-out-amount" min="1" value="1" class="split-number-input">
                                                            <span class="input-label">trainees</span>
                                                            <button type="button" id="split-cohort-btn" class="btn btn-secondary btn-sm split-btn-inline">
                                                                Split
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    
                                    <div id="split-preview" class="split-preview-enhanced"></div>
                                    
                                    <!-- Hidden original input for compatibility -->
                                    <input type="number" id="split-size" min="1" readonly style="display: none;">
                                </div>
                            </div>

                            <!-- Right Column: Line Training Configuration -->
                            <div class="cohort-right-column">
                                <h4>Line Training Configuration</h4>
                                
                                <div id="cohort-lt-config" class="cohort-lt-configuration">
                                    <!-- Line training configuration table will be generated here -->
                                </div>
                                
                                <!-- LT Extension Controls (below the table) -->
                                <div class="lt-extension-section">
                                    <h5>Duration Adjustment</h5>
                                    <div class="lt-extension-controls">
                                        <label for="lt-extension-amount">Adjust by:</label>
                                        <input type="number" id="lt-extension-amount" name="ltExtensionAmount" 
                                               value="0" min="-10" max="20" step="1">
                                        <span>fortnights</span>
                                        <label for="lt-extension-type">Type:</label>
                                        <select id="lt-extension-type" name="ltExtensionType">
                                            <option value="">Select LT type</option>
                                        </select>
                                    </div>
                                    <div id="lt-extension-preview" class="lt-extension-preview"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Cross-location config (spans full width when visible) -->
                        <div id="cross-location-config" class="cross-location-section" style="display: none;">
                            <!-- Cross-location configuration will be dynamically generated here -->
                        </div>

                        <div class="modal-footer">
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                            <button type="button" class="btn btn-secondary modal-cancel">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Modal for Priority Settings -->
        <div id="priority-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Edit Priority Settings</h2>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="priority-edit-form">
                        <div id="priority-edit-container">
                            <!-- Priority edit form will be generated here -->
                        </div>
                        <div class="modal-footer">
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                            <button type="button" class="btn btn-secondary modal-cancel">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- FTE Override Context Menu -->
        <div id="fte-context-menu" class="fte-context-menu">
            <button class="fte-context-menu-item" data-action="edit-single">
                <span class="fte-context-menu-icon">üìù</span>
                Edit this fortnight
            </button>
            <button class="fte-context-menu-item" data-action="edit-range">
                <span class="fte-context-menu-icon">üìÖ</span>
                Edit range...
            </button>
            <button class="fte-context-menu-item" data-action="edit-forward">
                <span class="fte-context-menu-icon">‚è≠Ô∏è</span>
                Edit from here forward
            </button>
            <div class="fte-context-menu-separator"></div>
            <button class="fte-context-menu-item" data-action="clear-override">
                <span class="fte-context-menu-icon">‚ùå</span>
                Clear
            </button>
        </div>

        <!-- FTE Override Modal -->
        <div id="fte-override-modal" class="modal">
            <div class="modal-content fte-override-modal-content">
                <div class="modal-header">
                    <h2 id="override-modal-title">Edit FTE Override</h2>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="modal-body fte-override-modal-body">
                    <form id="override-edit-form">
                        <div id="override-range-info" class="override-range-display"></div>
                        
                        <div class="override-edit-section">
                            <h4>Trainer Categories</h4>
                            <div id="override-categories-container" class="override-categories-grid">
                                <!-- Categories will be populated here -->
                            </div>
                        </div>

                        <div class="override-summary">
                            <h4>Preview</h4>
                            <div id="override-preview-content" class="override-preview-box">
                                <!-- Preview will be populated here -->
                            </div>
                        </div>

                        <div class="modal-footer">
                            <button type="submit" class="btn btn-primary">Apply Override</button>
                            <button type="button" class="btn btn-secondary modal-cancel">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <!-- Training Planner Modal -->
        <div id="training-planner-modal" class="modal">
            <div class="modal-content" style="max-width: 800px;">
                <span class="modal-close">&times;</span>
                <h2>Training Planner</h2>
                
                <div class="planner-tabs">
                    <button class="planner-tab active" data-tab="grid">Grid Entry</button>
                    <button class="planner-tab" data-tab="target">Target Optimizer</button>
                    <button class="planner-tab" data-tab="bulk">Bulk Input</button>
                    <button class="planner-tab" data-tab="smart">Smart Optimizer</button>
                </div>
                
                <!-- Grid Entry Tab -->
                <div id="grid-tab" class="planner-content active">
                    <h3>Grid Entry</h3>
                    <p>Quickly add multiple cohorts by entering trainee numbers in the grid</p>
                    <p style="font-size: 0.85em; color: #666; margin-top: -10px;">
                        üí° Tip: You can paste data from Excel! Copy your data and paste into any cell.
                    </p>
                    
                    <div class="grid-entry-form">
                        <div class="grid-period-selector" style="display: flex; gap: 15px; margin-bottom: 20px; align-items: center;">
                            <label>Planning Period:</label>
                            <select id="grid-start-month" style="width: 120px;">
                                <option value="0">January</option>
                                <option value="1">February</option>
                                <option value="2">March</option>
                                <option value="3">April</option>
                                <option value="4">May</option>
                                <option value="5">June</option>
                                <option value="6">July</option>
                                <option value="7">August</option>
                                <option value="8">September</option>
                                <option value="9">October</option>
                                <option value="10">November</option>
                                <option value="11">December</option>
                            </select>
                            <select id="grid-start-year" style="width: 80px;">
                                <option value="2024">2024</option>
                                <option value="2025" selected>2025</option>
                                <option value="2026">2026</option>
                                <option value="2027">2027</option>
                                <option value="2028">2028</option>
                                <option value="2029">2029</option>
                                <option value="2030">2030</option>
                                <option value="2031">2031</option>
                                <option value="2032">2032</option>
                                <option value="2033">2033</option>
                                <option value="2034">2034</option>
                            </select>
                            <label>to</label>
                            <select id="grid-end-month" style="width: 120px;">
                                <option value="0">January</option>
                                <option value="1">February</option>
                                <option value="2">March</option>
                                <option value="3">April</option>
                                <option value="4">May</option>
                                <option value="5" selected>June</option>
                                <option value="6">July</option>
                                <option value="7">August</option>
                                <option value="8">September</option>
                                <option value="9">October</option>
                                <option value="10">November</option>
                                <option value="11">December</option>
                            </select>
                            <select id="grid-end-year" style="width: 80px;">
                                <option value="2024">2024</option>
                                <option value="2025" selected>2025</option>
                                <option value="2026">2026</option>
                                <option value="2027">2027</option>
                                <option value="2028">2028</option>
                                <option value="2029">2029</option>
                                <option value="2030">2030</option>
                                <option value="2031">2031</option>
                                <option value="2032">2032</option>
                                <option value="2033">2033</option>
                                <option value="2034">2034</option>
                            </select>
                            <button id="show-grid" class="btn btn-secondary" style="display: none;">Show Grid</button>
                        </div>
                        
                        <div id="grid-container" style="display: none;">
                            <!-- Grid will be generated here -->
                        </div>
                        
                        <div class="modal-footer" style="display: none;" id="grid-footer">
                            <div style="margin-right: auto;">
                                <span id="grid-total-cohorts">Total Cohorts: 0</span> | 
                                <span id="grid-total-trainees">Total Trainees: 0</span>
                            </div>
                            <button id="grid-clear" class="btn btn-secondary">Clear</button>
                            <button id="grid-cancel" class="btn btn-secondary">Cancel</button>
                            <button id="grid-apply" class="btn btn-primary">Add All Cohorts</button>
                        </div>
                    </div>
                </div>
                
                <!-- Target Optimizer Tab -->
                <div id="target-tab" class="planner-content">
                    <h3>Target-Based Optimizer</h3>
                    <form id="target-form">
                        <div class="target-inputs" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 15px;">
                            <div class="form-group">
                                <label>CP Pilots:</label>
                                <input type="number" id="target-cp" min="0" value="0">
                            </div>
                            <div class="form-group">
                                <label>FO Pilots:</label>
                                <input type="number" id="target-fo" min="0" value="0">
                            </div>
                            <div class="form-group">
                                <label>CAD Pilots:</label>
                                <input type="number" id="target-cad" min="0" value="0">
                            </div>
                            <div class="form-group">
                                <label>Target Date:</label>
                                <input type="date" id="target-date" required>
                            </div>
                        </div>
                        <div class="optimizer-options" style="display: flex; gap: 30px; margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; cursor: pointer; font-weight: normal;">
                                <input type="checkbox" id="consider-existing" checked style="margin-right: 8px;">
                                <span title="Work around existing cohorts to avoid GS+SIM conflicts and trainer overload">Respect existing constraints</span>
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer; font-weight: normal;">
                                <input type="checkbox" id="smooth-schedule" style="margin-right: 8px;">
                                <span title="Spread training over longer period to stay within trainer capacity">Smooth schedule</span>
                            </label>
                        </div>
                        <div id="optimization-results" class="optimization-results"></div>
                        <div class="modal-footer">
                            <button id="copy-optimization-results" class="btn btn-secondary" style="margin-right: auto;">üìã Copy Results</button>
                            <button type="submit" class="btn btn-secondary">Optimize Schedule</button>
                            <button id="apply-optimized" class="btn btn-primary" disabled>Apply Schedule</button>
                        </div>
                    </form>
                </div>
                
                <!-- Bulk Input Tab -->
                <div id="bulk-tab" class="planner-content">
                    <h3>Bulk Cohort Input</h3>
                    <p style="margin-bottom: 10px;">Enter cohorts using any of these formats:</p>
                    <ul style="font-size: 0.9em; margin-bottom: 15px; color: #666;">
                        <li><strong>Jan 2025: 4 CAD, 2 FO</strong> - Multiple cohorts per month</li>
                        <li><strong>Jan 25 4 CAD A209</strong> - Specific pathway ID (A209)</li>
                        <li><strong>4 CAD Jan 2025</strong> - Alternative order</li>
                        <li>Use 2 or 4 digit years (25 = 2025)</li>
                    </ul>
                    <textarea id="bulk-input" rows="6" style="width: 100%; font-family: monospace;" placeholder="Jan 2025: 12 FO, 8 CP
Feb 25: 10 CAD, 6 CP
Mar 25 4 CAD A209
4 FO Apr 2025
May 2025: 2 CAD A212, 4 FO A210"></textarea>
                    <div id="bulk-validation" class="validation-results" style="max-height: 300px; overflow-y: auto;"></div>
                    <div class="modal-footer">
                        <button id="validate-bulk" class="btn btn-secondary">Validate</button>
                        <button id="apply-bulk" class="btn btn-primary" disabled>Apply Schedule</button>
                    </div>
                </div>
                
                <!-- Smart Optimizer Tab -->
                <div id="smart-tab" class="planner-content">
                    <h3>Smart Optimizer</h3>
                    <p>Set your training targets and get intelligent recommendations with partial achievement analysis.</p>
                    
                    <!-- Step 1: Input Phase -->
                    <div id="smart-input-phase">
                        <div class="smart-input-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin: 20px 0;">
                            <div class="form-group">
                                <label>Captains Target:</label>
                                <input type="number" id="smart-target-cp" min="0" value="0" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>First Officers Target:</label>
                                <input type="number" id="smart-target-fo" min="0" value="0" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Cadets Target:</label>
                                <input type="number" id="smart-target-cad" min="0" value="0" class="form-control">
                            </div>
                        </div>
                        <div class="form-group" style="margin: 20px 0;">
                            <label>Complete by:</label>
                            <input type="date" id="smart-target-date" class="form-control" style="width: 200px;">
                        </div>
                        <button id="analyze-feasibility" class="btn btn-primary" style="width: 200px;">Analyze Feasibility ‚Üí</button>
                    </div>
                    
                    <!-- Step 2: Results Phase (hidden initially) -->
                    <div id="smart-results-phase" style="display: none;">
                        <!-- Results will be dynamically inserted here -->
                    </div>
                    
                    <!-- Step 3: Options Phase (hidden initially) -->
                    <div id="smart-options-phase" style="display: none;">
                        <!-- Options will be dynamically inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

        <!-- Scenarios View -->
        <div id="scenarios-view" class="view">
            <!-- Current Scenario Section -->
            <section>
                <div class="section-header">
                    <h2>Current Scenario</h2>
                    <div class="scenario-status">
                        <span id="current-scenario-name">New Scenario</span>
                    </div>
                </div>
                <div class="scenario-actions-container">
                    <div class="scenario-info-card">
                        <p class="scenario-description">Save your current configuration as a scenario to reload it later or create variations.</p>
                        <div class="scenario-actions">
                            <button id="update-current-scenario" class="btn btn-secondary" style="display: none;">Save Current</button>
                            <button id="save-current-scenario" class="btn btn-primary">Save As New Scenario</button>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Saved Scenarios Section -->
            <section>
                <div class="section-header">
                    <h2>Saved Scenarios</h2>
                    <div class="scenario-controls">
                        <input type="text" id="scenario-search" placeholder="Search scenarios..." class="search-input">
                        <select id="scenario-sort" class="filter-select">
                            <option value="date-desc">Newest First</option>
                            <option value="date-asc">Oldest First</option>
                            <option value="name-asc">Name (A-Z)</option>
                            <option value="name-desc">Name (Z-A)</option>
                            <option value="size-desc">Largest First</option>
                            <option value="size-asc">Smallest First</option>
                        </select>
                        <div class="view-toggle">
                            <button id="view-grid" class="view-btn active" title="Grid view">‚äû</button>
                            <button id="view-list" class="view-btn" title="List view">‚ò∞</button>
                        </div>
                        <button id="new-scenario" class="btn btn-primary" title="Create a new scenario">New Scenario</button>
                        <button id="compare-scenarios" class="btn btn-secondary" title="Compare two scenarios" disabled>Compare</button>
                        <button id="export-all-scenarios" class="btn btn-secondary" title="Export all scenarios">Export All</button>
                        <button id="import-scenarios" class="btn btn-secondary" title="Import scenarios">Import</button>
                        <input type="file" id="import-file-input" accept=".json" style="display: none;">
                        <span class="scenario-count">0 scenarios</span>
                    </div>
                </div>
                <div id="scenario-list" class="scenario-list">
                    <!-- Scenario cards will be generated here -->
                </div>
            </section>
        </div>

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>
    
    <!-- Clear Highlights Button -->
    <button id="clear-highlights-btn" class="clear-highlights-btn" onclick="clearAllHighlights()">
        Clear Highlights (<span id="highlight-count">0</span>)
    </button>

    <!-- Import Rename Modal -->
    <div id="import-rename-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>Scenario Name Conflict</h2>
            </div>
            <div class="modal-body">
                <p id="import-conflict-message">A scenario with this name already exists.</p>
                <div class="form-group">
                    <label for="import-rename-input">New Name:</label>
                    <input type="text" id="import-rename-input" required>
                </div>
                <div class="modal-actions">
                    <button id="import-rename-btn" class="btn btn-primary">Rename</button>
                    <button id="import-overwrite-btn" class="btn btn-warning">Overwrite</button>
                    <button id="import-skip-btn" class="btn btn-secondary">Skip</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scenario Comparison Modal -->
    <div id="comparison-modal" class="modal">
        <div class="modal-content" style="max-width: 1200px;">
            <div class="modal-header">
                <h2 id="comparison-title">Scenario Comparison</h2>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div id="comparison-content">
                    <!-- Comparison content will be generated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Scenario Save Modal -->
    <div id="scenario-save-modal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 id="scenario-modal-title">Save Scenario</h2>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="scenario-save-form">
                    <div class="form-group">
                        <label for="scenario-name">Scenario Name:</label>
                        <input type="text" id="scenario-name" name="scenarioName" required placeholder="e.g., Q1 2025 Plan">
                    </div>
                    <div class="form-group">
                        <label for="scenario-description">Description (optional):</label>
                        <textarea id="scenario-description" name="scenarioDescription" rows="3" 
                                  placeholder="Add notes about this scenario..."></textarea>
                    </div>
                    <div class="scenario-preview">
                        <h3>Preview</h3>
                        <div class="preview-stats">
                            <div class="preview-item">
                                <span class="preview-label">Total Cohorts:</span>
                                <span id="preview-cohorts" class="preview-value">0</span>
                            </div>
                            <div class="preview-item">
                                <span class="preview-label">Total Trainees:</span>
                                <span id="preview-trainees" class="preview-value">0</span>
                            </div>
                            <div class="preview-item">
                                <span class="preview-label">Training Period:</span>
                                <span id="preview-daterange" class="preview-value">-</span>
                            </div>
                            <div class="preview-item">
                                <span class="preview-label">Pathways:</span>
                                <span id="preview-pathways" class="preview-value">-</span>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary">Save Scenario</button>
                        <button type="button" class="btn btn-secondary modal-cancel">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Alert Dialog -->
    <div id="alert-dialog" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 400px; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);">
            <div class="modal-header">
                <h2 id="alert-title">Invalid Date Range</h2>
            </div>
            <div class="modal-body" style="text-align: center; padding: 20px;">
                <p id="alert-message" style="margin-bottom: 20px;">The end date cannot be before the start date. Please select a valid date range.</p>
                <button id="alert-ok" class="btn btn-primary">OK</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Dialog -->
    <div id="confirm-dialog" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 400px; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);">
            <div class="modal-header">
                <h2 id="confirm-title">Clear Grid</h2>
            </div>
            <div class="modal-body" style="text-align: center; padding: 20px;">
                <p id="confirm-message" style="margin-bottom: 20px;">Clear all entries in the grid?</p>
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button id="confirm-yes" class="btn btn-primary">Yes</button>
                    <button id="confirm-no" class="btn btn-secondary">No</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="help-modal" class="modal help-modal" style="display: none;">
        <div class="modal-content help-modal-content">
            <div class="help-header">
                <input type="text" id="help-search" class="help-search" placeholder="üîç Search help..." autocomplete="off">
                <button class="modal-close help-close">&times;</button>
            </div>
            <div class="help-body">
                <nav class="help-nav">
                    <ul class="help-nav-list">
                        <li><a href="#" data-section="getting-started" class="help-nav-item active">Getting Started</a></li>
                        <li><a href="#" data-section="dashboard" class="help-nav-item">Dashboard</a></li>
                        <li><a href="#" data-section="planner" class="help-nav-item">Training Planner</a></li>
                        <li><a href="#" data-section="settings" class="help-nav-item">Settings</a></li>
                        <li><a href="#" data-section="scenarios" class="help-nav-item">Scenarios</a></li>
                        <li><a href="#" data-section="calculations" class="help-nav-item">Calculations</a></li>
                        <li><a href="#" data-section="tips" class="help-nav-item">Tips & Tricks</a></li>
                        <li><a href="#" data-section="qa" class="help-nav-item">Q&A</a></li>
                    </ul>
                </nav>
                <main class="help-content" id="help-content">
                    <!-- Content will be loaded dynamically -->
                </main>
            </div>
            <div class="help-footer">
                <button id="help-tour-btn" class="btn btn-secondary">Start Interactive Tour</button>
                <span class="help-version">Version 1.14.0</span>
            </div>
        </div>
    </div>

    <!-- Deficit Resolution Assistant -->
    
    <!-- Deficit Resolution Modal -->
    <div id="deficit-resolution-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Deficit Resolution Assistant</h2>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Compact Deficit Summary -->
                <div id="deficit-summary-section">
                    <div class="deficit-description">Select cohorts below to reschedule them to periods with available capacity. The table shows current trainer availability and how your changes will impact the schedule.</div>
                    <div id="deficit-summary-content">
                        <!-- Compact deficit summary will be inserted here -->
                    </div>
                </div>
                
                <!-- Two columns for solutions and preview -->
                <div id="solutions-preview-section">
                    <!-- Left Column: Solutions -->
                    <div id="solutions-column">
                        <div class="section-header">Cohorts to Reschedule</div>
                        <div id="deficit-solutions">
                            <!-- Solutions will be dynamically inserted here -->
                        </div>
                    </div>
                    
                    <!-- Right Column: Preview -->
                    <div id="preview-column">
                        <div class="section-header">Selected Moves</div>
                        <div id="preview-content">
                            <div class="preview-placeholder">
                                Select cohorts to see moves
                            </div>
                            <!-- Preview will be dynamically updated here -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="apply-deficit-solutions" class="btn btn-primary" disabled>Apply Selected Solutions</button>
                <button class="btn btn-secondary modal-cancel">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Import Training Modal -->
    <div id="import-training-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="import-training-modal-title">
        <div class="modal-content" style="max-width: 1000px;">
            <div class="modal-header">
                <h2 id="import-training-modal-title">Import Training Data</h2>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="import-controls">
                    <h3>Select File to Import</h3>
                    <div class="file-input-section" style="margin-bottom: 20px;">
                        <input type="file" id="import-training-file-input" accept=".csv,.xlsx,.xls" style="margin-bottom: 10px;">
                        <div class="import-format-hint" style="font-size: 0.9em; color: #666;">
                            Accepts CSV or Excel files. Expected columns: Training Type, Pathway ID, Pathway Name, Type, Start Date, No. Trainees, Usable Date
                        </div>
                    </div>
                    
                    <div class="import-options" style="margin-bottom: 20px; display: none;" id="import-options-section">
                        <h4>Import Options</h4>
                        <label style="display: block; margin-bottom: 10px;">
                            <input type="radio" name="import-mode" value="replace" checked>
                            Replace all existing cohorts
                        </label>
                        <label style="display: block;">
                            <input type="radio" name="import-mode" value="append">
                            Add to existing cohorts
                        </label>
                    </div>
                </div>
                
                <div class="validation-section" id="import-validation-section" style="display: none;">
                    <h3>Validation Results</h3>
                    <div class="validation-summary" id="validation-summary" style="margin-bottom: 15px; padding: 10px; border-radius: 5px;">
                        <!-- Summary will be shown here -->
                    </div>
                    
                    <div class="preview-section">
                        <div id="import-preview-container" style="max-height: 400px; overflow-y: auto;">
                            <table class="data-table" id="import-preview-table">
                                <thead>
                                    <tr>
                                        <th style="width: 40px;">Status</th>
                                        <th>Pathway ID</th>
                                        <th>Pathway Name</th>
                                        <th>Type</th>
                                        <th>Start Date</th>
                                        <th>No. Trainees</th>
                                        <th>Issues</th>
                                    </tr>
                                </thead>
                                <tbody id="import-preview-tbody">
                                    <!-- Preview data will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="fix-options" id="fix-options" style="margin-top: 15px; display: none;">
                        <h4>Quick Fixes</h4>
                        <button class="btn btn-secondary" id="skip-invalid-btn" style="margin-right: 10px;">
                            Skip Invalid Rows
                        </button>
                        <button class="btn btn-secondary" id="fix-dates-btn" style="margin-right: 10px;">
                            Auto-fix Date Formats
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <span id="import-location-label" style="color: #007bff; margin-right: auto;"></span>
                <button id="import-training-confirm" class="btn btn-primary" disabled>Import Valid Cohorts</button>
                <button class="btn btn-secondary modal-cancel">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Export Training Modal -->
    <div id="export-training-modal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2>Export Training Data</h2>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="export-controls">
                    <h3>Select Date Range</h3>
                    <div class="date-range-selector" style="display: flex; gap: 20px; margin-bottom: 20px;">
                        <div class="date-input-group">
                            <label>From:</label>
                            <select id="export-from-year" style="width: 100px;">
                                <!-- Years will be populated dynamically -->
                            </select>
                            <select id="export-from-fortnight" style="width: 150px;">
                                <!-- Fortnights will be populated dynamically -->
                            </select>
                        </div>
                        <div class="date-input-group">
                            <label>To:</label>
                            <select id="export-to-year" style="width: 100px;">
                                <!-- Years will be populated dynamically -->
                            </select>
                            <select id="export-to-fortnight" style="width: 150px;">
                                <!-- Fortnights will be populated dynamically -->
                            </select>
                        </div>
                    </div>
                    
                    <div class="export-options" style="margin-bottom: 20px;">
                        <label>
                            <input type="radio" name="export-view" value="detailed" checked>
                            Detailed View (one row per cohort)
                        </label>
                        <label style="margin-left: 20px;">
                            <input type="radio" name="export-view" value="summary">
                            Summary View (grouped by pathway)
                        </label>
                    </div>
                </div>
                
                <div class="preview-section">
                    <h3>Preview <span id="export-location-label" style="color: #007bff;"></span></h3>
                    <div id="export-preview-container" style="max-height: 400px; overflow-y: auto;">
                        <table class="data-table" id="export-preview-table">
                            <thead>
                                <tr>
                                    <th>Training Type</th>
                                    <th>Pathway ID</th>
                                    <th>Pathway Name</th>
                                    <th>Type</th>
                                    <th>Start Date</th>
                                    <th>No. Trainees</th>
                                    <th>Usable Date</th>
                                </tr>
                            </thead>
                            <tbody id="export-preview-tbody">
                                <!-- Preview data will be populated here -->
                            </tbody>
                        </table>
                        <div id="export-no-data" style="text-align: center; padding: 40px; color: #666; display: none;">
                            No training cohorts found in the selected date range.
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="export-training-excel" class="btn btn-primary" disabled>Export to Excel</button>
                <button class="btn btn-secondary modal-cancel">Cancel</button>
            </div>
        </div>
    </div>

    <!-- SheetJS library for Excel export/import -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="app.js"></script>
</body>
</html>
